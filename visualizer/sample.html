<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="/css/twbs/bootstrap.min.css" type="text/css">
        <style>
            body {
                background-color: #d1d1f1;
            }
            #viewer,#tree {
                outline: solid;
                border-radius: 2pt;
                background-color: white;
                overflow: hidden
            }
            h1 {
                font-family: 'Myriad Pro', 'Noto Sans', 'Lucida Sans', Verdana, 'Liberation Sans', sans-serif;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid">
            <header><h1 id="sname"></h1></header>
            <ul class="nav nav-tabs">
                <li class="active"><a href="#tree-tab" data-toggle="tab">Phylogenetic Tree</a></li>
                <li><a href="#alignment-tab" data-toggle="tab">Alignment</a></li>
            </ul>
            <div id="tabs-container" class="tab-content" style="height: 100%;">
                <div class="tab-pane fade active in" id="tree-tab" style="height: 100%;">
                            <div id="tree" style="height: 100%;"></div>
                </div>
                <div class="tab-pane fade" id="alignment-tab">
                    <div id="viewer"></div>
                </div>
            </div>
        </div>

        <script src="/js/jquery/jquery.slim.min.js"></script>
        <script src="/js/twbs/bootstrap.min.js"></script>
        <script src="/js/big-integer/BigInteger.min.js"></script>
        <script src="/js/underscore/underscore-umd-min.js"></script>
        <script src="/js/spin/spin.min.js"></script>
        <script src="/js/d3/d3.min.js"></script>
        <script src="/js/cjson/circular-json.js"></script>
        <script src="/js/cblob/canvas-toBlob.js"></script>
        <script src="/js/filesaver/FileSaver.min.js"></script>
        <script src="/js/igv/igv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/DessimozLab/phylo-io@1.9/www/js/treecompare.js"></script>

        <script>
            var p = new URLSearchParams(window.location.search);
            var s = p.get('s')

            header = document.getElementById('sname');
            header.innerHTML = s;

            var phylotree
            var preq = new XMLHttpRequest();
            preq.onload = preqlistener;
            function preqlistener(e) {
                phylotree = this.responseText;
            }
            preq.open('GET', '/data/'+s+'.tree', false);
            preq.send();

            var treecomp = TreeCompare().init({
                treeHeight: 600
            });
            tree = treecomp.addTree(phylotree, undefined, 'single');
            treecomp.viewTree(tree.name, 'tree');

            var reference
            var req = new XMLHttpRequest();
            req.onload = reqlistener;
            function reqlistener(e) {
                reference = JSON.parse(this.responseText)[0];
            }
            req.open('GET', '/reference', false)
            req.send()

            igvDiv = document.getElementById('viewer');
            options = {
                reference: {
                    id: reference.slice(0,-6),
                    fastaURL: "data/"+reference
                },
                tracks: [
                    {
                        type: 'alignment',
                        format: 'bam',
                        url: 'data/'+s+'.bam',
                        indexURL: 'data/'+s+'.bam.bai',
                        name: s
                    },
                    {
                        type: 'alignment',
                        format: 'bam',
                        url: 'data/'+s+'.contigs.bam',
                        indexURL: 'data/'+s+'.contigs.bam.bai',
                        name: s+'.contigs'
                    }
                ]
            }
            igv.createBrowser(igvDiv, options).
                then(function(browser) {
                    igv.browser = browser;
                });
        </script>
    </body>
</html>
