name: nf-core CI
# This workflow runs the pipeline with the minimal test dataset to check that it completes without any syntax errors
on:
  push:
    branches:
      - develop
  pull_request:
  release:
    types: [published]
  workflow_dispatch:

env:
  NXF_ANSI_LOG: false
  CAPSULE_LOG: none

jobs:
  versions:
    name: Run pipeline tests with different Nextflow versions
    # Only run on push if this is the develop branch (merged PRs)
    if: ${{ github.event_name != 'push' || (github.event_name == 'push' && github.repository == 'ksumngs/yavsap') }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - NXF_VER: ""
            NXF_EDGE: "1"
            TEST: "Test Illumina"
          - NXF_VER: ""
            NXF_EDGE: "1"
            TEST: "Test Nanopore"
          - NXF_VER: "21.10.3"
            NXF_EDGE: ""
            TEST: "Test Illumina"
          - NXF_VER: "21.10.3"
            NXF_EDGE: "1"
            TEST: "Test Nanopore"
    steps:
      - name: Check out pipeline code
        uses: actions/checkout@v3
      - name: Install Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Install Pytest and extensions
        uses: logikal-code/pip-install@v1.0.0
        with:
          requirements: tests/requirements.txt
      - name: Install Nextflow
        env:
          NXF_VER: ${{ matrix.NXF_VER }}
          NXF_EDGE: ${{ matrix.NXF_EDGE }}
        run: |
          wget -qO- get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin
          nextflow self-update
      - name: Run tests
        run: |
          pytest --git-aware --tag ${{ matrix.TEST }}

  test:
    name: Run pipeline tests
    if: ${{ github.event_name != 'push' || (github.event_name == 'push' && github.repository == 'ksumngs/yavsap') }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        GROUP: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    steps:
      - name: Check out pipeline code
        uses: actions/checkout@v3
      - name: Install Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Install Pytest and extensions
        uses: logikal-code/pip-install@v1.0.0
        with:
          requirements: tests/requirements.txt
      - name: Install Nextflow
        run: |
          wget -qO- get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin
      - name: Run tests
        run: |
          pytest --git-aware --test-group-count 20 --test-group=${{ matrix.GROUP }} --test-group-random-seed=1
