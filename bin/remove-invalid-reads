#!/bin/bash
# -*- mode: julia -*-
#=
julia --project="$(realpath "$(dirname "${BASH_SOURCE[0]}")")" -e 'using Pkg; Pkg.instantiate()'
exec julia --project="$(realpath "$(dirname "${BASH_SOURCE[0]}")")" "${BASH_SOURCE[0]}" "$@"
=#
# Removes reads from a BAM file that have a CIGAR longer than the sequence
# (These kind of reads tend to foul-up the haplotype callers)

using BGZFStreams
using XAM

infile  = ARGS[1]
outfile = ARGS[2]

open(BAM.Reader, infile) do bamfile
    h = BAM.header(bamfile)
    output = BAM.Writer(BGZFStream(open(outfile, "w"), "w"), h)
        bamrecords = filter(r -> BAM.alignlength(r) .<= BAM.seqlength(r), collect(bamfile))
        for bamrecord in bamrecords
            write(output, bamrecord)
        end
    close(output)
end
