#!/usr/bin/env Rscript

# Import libraries
library(phylotools)

# Read in the cli arguments
args <- commandArgs(trailingOnly = TRUE)
fasta_in <- args[1]
sample_name <- args[2]
fasta_out <- args[3]

# Get the old names
fasta_raw <- read.fasta(fasta_in, clean_name = FALSE)
name_changes <- data.frame(old = fasta_raw[1]$seq.name, new = NA)

# HapLink.jl consensus sequence rename
# e.g. SAMPLE_CONSENSUS -> SAMPLE_consensus
haplink_consensus_indexes <- endsWith(name_changes$old, "CONSENSUS")
if (sum(haplink_consensus_indexes) > 0) {
    name_changes[haplink_consensus_indexes, ]$new <-
        paste(sample_name, "consensus", sep = "_")
}

# HapLink.jl haplotype sequence rename
# e.g. ???????? ... -> SAMPLE_haplotype_????????
# This might clash with CliqueSNV if the samplename is entirely hex, so do it
# first
haplink_indexes <- grepl("^[0-9a-f]{8}\\s.*", name_changes$old)
if (sum(haplink_indexes) > 0) {
    name_changes[haplink_indexes, ]$new <-
        paste(
            sample_name,
            "haplotype",
            substr(name_changes[haplink_indexes, ]$old, 1, 8),
            sep = "_"
        )
}

# CliqueSNV haplotype sequence rename
# e.g. SAMPLE_##_... -> SAMPLE_haplotype_##+
cliquesnv_indexes <- grepl("^.+_[0-9]+_.*", name_changes$old)
if (sum(cliquesnv_indexes) > 0) {
    name_changes[cliquesnv_indexes, ]$new <-
        paste(
            sample_name,
            "haplotype",
            sapply(
                strsplit(name_changes[cliquesnv_indexes, ]$old, "_"),
                "[[",
                2
            ),
            sep = "_"
        )
}

rename.fasta(fasta_in, name_changes, fasta_out)
