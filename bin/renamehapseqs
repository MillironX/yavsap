#!/usr/bin/env Rscript

# Import libraries
library(phylotools)

# Read in the cli arguments
args <- commandArgs(trailingOnly = TRUE)
fasta_in <- args[1]
sample_name <- args[2]
fasta_out <- args[3]

# Get the old names
fasta_raw <- read.fasta(fasta_in, clean_name = FALSE)
name_changes <- data.frame(old = fasta_raw[1]$seq.name, new = NA)

# iVar consensus sequence rename
# e.g. Consensus_SAMPLE_... -> SAMPLE_consensus
if (sum(startsWith(name_changes$old, "Consensus")) > 0) {
    name_changes[startsWith(name_changes$old, "Consensus"), ]$new <-
        paste(sample_name, "consensus", sep = "_")
}

# HapLink.jl consensus sequence rename
# e.g. SAMPLE_CONSENSUS -> SAMPLE_consensus
if (sum(endsWith(name_changes$old, "CONSENSUS")) > 0) {
    name_changes[endsWith(name_changes$old, "CONSENSUS"), ]$new <-
        paste(sample_name, "consensus", sep = "_")
}

# HapLink.jl haplotype sequence rename
# e.g. ???????? ... -> SAMPLE_haplotype_????????
# This might clash with CliqueSNV if the samplename is entirely hex, so do it
# first
if (sum(grepl("^[0-9a-f]{8}\\s.*", name_changes$old)) > 0) {
    name_changes[grepl("^[0-9a-f]{8}\\s.*", name_changes$old), ]$new <-
        paste(
            sample_name,
            "haplotype",
            substr(
                name_changes[grepl("^[0-9a-f]{8}.*", name_changes$old), ]$old,
                1,
                8
            ),
            sep = "_"
        )
}

# CliqueSNV haplotype sequence rename
# e.g. SAMPLE_##_... -> SAMPLE_haplotype_##
if (sum(grepl("^.+_[0-9]+_.*", name_changes$old)) > 0) {
    name_changes[grepl("^.+_[0-9]+_.*", name_changes$old), ]$new <-
        paste(
            sample_name,
            "haplotype",
            sapply(
                strsplit(
                    name_changes[grepl(
                        "^.+_[0-9]+_.*",
                        name_changes$old
                    ), ]$old,
                    "_"
                ),
                "[[",
                2
            ),
            sep = "_"
        )
}

rename.fasta(fasta_in, name_changes, fasta_out)
