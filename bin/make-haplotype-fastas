#!/bin/bash
# -*- mode: julia -*-
#=
julia --project="$(realpath "$(dirname "${BASH_SOURCE[0]}")")" -e 'using Pkg; Pkg.instantiate()'
exec julia --project="$(realpath "$(dirname "${BASH_SOURCE[0]}")")" "${BASH_SOURCE[0]}" "$@"
=#
# Converts a reference sequence and haplotype definitions to FASTA format

using FASTX
using YAML

hfile = ARGS[1]
rfile = ARGS[2]
ffile = ARGS[3]

include("yavsap-function-lib.jl")

haployaml = read(hfile, String)
haplostrings = split(haployaml, "---\n")[2:end]
haplotypes = Haplotype.(YAML.load.(haplostrings, dicttype=Dict{String,Any}))

rreader = open(FASTA.Reader, rfile)
refrec = collect(rreader)[1]
close(rreader)

newrecords = unique(mutaterecord.([refrec], haplotypes))

fwriter = open(FASTA.Writer, ffile)
for r in newrecords
    write(fwriter, r)
end
close(fwriter)
